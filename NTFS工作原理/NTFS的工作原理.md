#NTFS的工作原理
##概述
NTFS（英语：New Technology File System），是Microsoft公司开发的专用文件系统，从Windows NT 3.1开始成为Windows NT家族的标准文件系统。

NTFS取代FAT（文件分配表）和HPFS（高性能文件系统）并进行一系列改进，例如增强对元数据的支持，使用更高级的数据结构以提升性能、可靠性和磁盘空间利用率，并附带一系列增强功能，如访问控制列表（ACL）和文件系统日志。对于我们使用者来说，最直观的感觉就是当系统意外掉电后，采用NTFS的文件系统的操作系统相对于FAT文件系统的操作系统的开机自检几乎没有再出现过，文件的安全性和可靠性得到在大大的加强，其实NTFS文件的特点不仅如此,还包括以下几点：

##特征
* 支持大小

  NTFS可以支持的分区(如果采用动态磁盘则称为卷)大小可以达到2TB。而Windows2000中的FAT32支持分区的大小最大为32GB。

* 文件系统

  NTFS是一个可恢复的文件系统。在NTFS分区上用户很少需要运行磁盘修复程序。NTFS通过使用标准的事务处理日志和恢复技术来保证分区的一致性。发生系统失败事件时，NTFS使用日志文件和检查点信息自动恢复文件系统的一致性。

* 文件夹压缩

  NTFS支持对分区、文件夹和文件的压缩。任何基于Windows的应用程序对NTFS分区上的压缩文件进行读写时不需要事先由其他程序进行解压缩，当对文件进行读取时，文件将自动进行解压缩；文件关闭或保存时会自动对文件进行压缩。

* 磁盘空间的有效管理

  NTFS采用了更小的簇,可以更有效率地管理磁盘空间。在Win 2000的FAT32文件系统的情况下，分区大小在2GB～8GB时簇的大小为4KB；分区大小在8GB～16GB时簇的大小为8KB；分区大小在16GB～32GB时,簇的大小则达到了16KB。而Win 2000的NTFS文件系统，当分区的大小在2GB以下时，簇的大小都比相应的FAT32簇小;当分区的大小在2GB以上时(2GB～2TB),簇的大小都为4KB。相比之下，NTFS可以比FAT32更有效地管理磁盘空间，最大限度地避免了磁盘空间的浪费。

* 更好的安全性

  在NTFS分区上，可以为共享资源、文件夹以及文件设置访问许可权限。许可的设置包括两方面的内容：一是允许哪些组或用户对文件夹、文件和共享资源进行访问；二是获得访问许可的组或用户可以进行什么级别的访问。访问许可权限的设置不但适用于本地计算机的用户,同样也应用于通过网络的共享文件夹对文件进行访问的网络用户。与FAT32文件系统下对文件夹或文件进行访问相比，安全性要高得多。另外，在采用NTFS格式的Win 2000中,应用审核策略可以对文件夹、文件以及活动目录对象进行审核，审核结果记录在安全日志中，通过安全日志就可以查看哪些组或用户对文件夹、文件或活动目录对象进行了什么级别的操作，从而发现系统可能面临的非法访问，通过采取相应的措施，将这种安全隐患减到最低。这些在FAT32文件系统下,是不能实现的。


##内部结构
###布局
NTFS文件系统大致可以分为引导区，MFT区，MFT备份区，数据区和DBR备份区。
![NTFS的系统布局](系统布局.png ''NTFS的系统布局'')

* 引导扇区和FAT32的引导区类似，是文件系统的保留区，第一扇区为DBR。一般包括文件系统的引导代码和数据。

* MFT区一般占文件系统大小的12.5%，一般当其它数据区写满后才会暂时使用这个空间。

* MFT备份区，说是备份区，其实只是备份了MFT区的部分数所在，只是MFT区的前几个项的备份。

* 引导扇区备份区在卷的最后一个扇区，其备份了一份DBR扇区的内容。

在内部，NTFS使用B+树索引文件系统数据。这种数据结构的方式实现比较复杂，但能够在大多数情况下提高文件的查找速度。文件系统日志用于确保文件的元数据完整，不存在孤立的文件内容。相比于FAT文件系统，NTFS文件系统的可靠性更高。

###主文件表MFT
磁盘分区在格式化成NTFS文件系统后，就为其创建了一个主的文件表MFT。当然格式化后，由于整个磁盘是空的，没有存储任何文件数据，所以在MFT中只存储了16个文件系统预置的元文件记录。这16个元文件记录存储在MFT的前16项。这16个文件如下：

![NTFS的元文件](元文件.png ''NTFS的元文件'')

NTFS文件系统MFT每项大小为1024个字节即2个扇区，分为固定大小的MFT头和属性列表。
>*NTFS是以文件为单位进行管理的，故MFT分区也有一个文件名为"$MFT",故其文件可按需要进行增加或缩小。MFT分区存储的是MFT项，也即$MFT文件中存储的是MFT项。为了提高磁盘的使用效率，MFT区一般会在文件系统格式化时会预分为整个文件系统的12.5%，且位于整个文件系统的中间靠前区域。*

###确定MFT的位置
分区刚开始的部分称为DBR ：分区引导扇区，位于逻辑扇区0，即第一个扇区。每个分区都有引导扇区，但是只有被设为活动区的才会被MBR（主引导记录区，整个磁盘的第一个扇区，用于引导系统启动）装入内存运行，以引导系统。DBR分为DOS引导程序和BPB(BIOS 参数块)，该块用来描述本分区的磁盘信息，其中，文件系统标识，扇区大小，簇大小和MFT起始簇号对我们有用，MFT位置=起始簇号\*簇大小\*扇区大小。

###元文件
NTFS包含若干用于定义和组织文件系统的文件。总体来说，这些文件中的绝大多数结构和其它用户文件类似（只有“$Volume”比较特殊），但不能被文件系统客户端直接访问。这些元文件为定义文件、备份文件系统的关键数据、缓存文件系统的更改、管理空闲空间的分配、满足BIOS的要求、跟踪坏扇区单元，以及储存安全信息和磁盘空间使用情况等等多种不同需求提供支持。

区块编号|文件名|作用
--|--|--
0|$MFT|描述卷上的所有文件，包括文件名、时间戳、流名称和数据流所在的簇的编号列表、索引、安全标识符，以及文件属性（如“只读”、“压缩”、“加密”等）。
1|$MFTMirr|$MFT的最开始的几个关键项的副本，通常是4项（4KiB）。
2|$LogFile|文件系统更改的事务日志，用于保护元数据的稳定性。
3|$Volume|卷的相关信息，如卷对象标识符、卷标、文件系统版本，以及若干卷标志（包括：“正在加载”、“需要扫描”、“需要调整$LogFile大小”、“在NT4上加载”、“正在更新卷序列号”、“需要升级结构”等）。这些数据不直接在数据流中存储，而是存储于特殊的 MFT 属性中。如果卷对象标识符存在，则将会在一个 $OJBECT_ID 记录中；卷标存储在 $VOLUME_NAME 记录中；其它数据存储在 $VOLUME_INFORMATION 记录中；卷序列号储存在$Boot文件中（请参见下文）。
4|$AttrDef|所有NTFS项目使用到的属性的定义表，包含属性名称、属性编号和属性描述等。
5|.|根目录。目录数据存储在两个名称均为 $I30 的 $INDEX_ROOT 和 $INDEX_ALLOCATIOn 属性中
6|$Bitmap|一个位图，每一位按顺序指示卷上的对应簇正在被使用（1）或空闲（0）。
7|$Boot|卷引导记录，该文件始终位于卷的第一个簇，其中包含引导代码（用于定位并启动NTLDR/BOOTMGR）、BIOS参数块（其中包含卷序列号），以及$MFT和$MFTMirr所在的簇编号。
8|$BadClus|包含所有标记为“有坏扇区”的簇的一个文件。该文件通常被chksdk（磁盘扫描）工具使用，用于管理所有簇状态，记录坏扇区，以及标记空白簇。该文件包含两个数据流（无论卷是否有坏道）：一个包含所有坏扇区编号的无名称流（如果卷没有坏扇区则该流长度为零），以及名称为$Bad的流，包含所有包含记录在第一个流中的簇。
9|$Secure|访问控制列表（ACL）数据库，NTFS将所有ACL信息集中存储于该数据库（而非每个文件独立存储各自的ACL）以节省磁盘占用并提高执行效率。此部分包含两个索引，分别是：“$SII”——可能是[来源请求]安全ID索引，以及“$SDH”——安全描述符哈希。注意大部分ACL列表通常都很长，因此这个部分只是索引，记录的是实际存储ACL数据的$SDS流的位置。[1]
10|$UpCase|Unicode大写字母表，用于确保在Win32和DOS名字空间下大小写不敏感。
11|$Extend|文件系统目录，用于包含若干操作系统或其它软件所需要的扩展数据，如$Quota、$ObjId、$Reparse、$UsnJrnl等。
12 ... 23|保留为 $MFT 扩展项使用。扩展项目是一系列附加MFT记录，用于描述未在主记录中包含的属性。例如，当卷需要磁盘清理，包含太多流，具有长文件名或者非常复杂的安全设定，以及其它特殊情况时，可能会用到保留项目
24|$Extend\$Quota|磁盘限额设置。包含两个索引根目录，名称分别为$O和$Q。
25|$Extend\$ObjId|分布链接跟踪数据。包含一个索引根目录，名称为$O。
26|$Extend\$Reparse|卷上所有重解析点（如符号链接）数据。包含一个索引根目录，名称为$R。
27 ...|file.ext|常规文件系统项目的起始位置。

###NTFS文件建立
假如我们要建立一个文件 “子目录1file.txt”,假设”子目录1”已经存在于根目录，是建立的file文件大小为7000个字节，每个簇大小为4096字节。
1. 读取文件第一个扇区的引导扇区，获取簇大小，MFT的起始位置以及每个MFT项的大小。
2. 读取第一个MFT项，即$MFT文件的MFT项，由它的$DATA属性获取其它MFT项的位置。
3. 为准备新建的文件建立MFT项，访问$MFT文件$BITMAP属性，找到一个未分配的项。第一个空闲项为400号，把它分配给新文件，并将$BITMAP中相应的位置1，说明已经被分配占用
4. 初始化MFT项，跳转到400号MFT项的位置，将其中的内容清除。建立标准信息属性($STANDARD_INFORMATION)和文件名属性（$FILE_NAME）,时间值设置为当前时间。在MFT项头中设置使用标记。
5. 从6号MFT项的$Bitmap文件中为文件的$DATA属性寻找并分配2个簇（因为7000个字节需要2个簇）。使用最佳分配策略找到2个连续的空闲簇722和723号，将其对应的bit置1，更新$DATA属性中的簇地址，修改MFT项，所以更新文件的最后修改时间值。
6. 为其添加文件名项。访问5号MFT项的根目录，定位“子目录1”。读取索引根属性($INDEX_ROOT)和索引分配属性（$INDEX_ALLOCATION）,在倒置树中分类寻找，找到”子目录1”的索引项，它的MFT项地址为200，更新目录的最后访问时间。
7. 跳转到200号MFT项，访问它的索引根属性（$INDEX_ROOT）,寻找将为file.txt分配的空间，为其建立一个新的索引项，重新对倒置树进行分为。新索引项的文件参考号地址是400号MFT项。设置相应的时间和标志。更新目录的最后写入，最后修改，最后访问时间值。
8. 在前面的每一步中，在文件日志中建立项并将改变记入$Extend$UsrJrnl。如果设置了配额管理，将新文件的大小记入用户的的配额中($Extend$Quota)

###NTFS 删除文件
1. 读取文件第一个扇区的引导扇区，获取簇大小，MFT的起始位置以及每个MFT项的大小。
2. 读取第一个MFT项，即$MFT文件的MFT项，由它的$DATA属性获取其它MFT项的位置。
3. 访问5号MFT项，即目录，通过索引根属性($INDEX_ROOT)和索引分配属性($INDEX_ALLOCATION)找到“子目录1”项，它的MFT项为200号，更新目录的最后访问时间。
4. 访问200号MFT项的索引根属性($INDEX_ROOT）并寻找file.txt的条目，找到它的MFT项为400号。
5. 从索引项中移除文件的项，移动节点中的项覆盖了原来的项，更新目录的最后写入时间，最后修改时间和最后访问时间。
6. 通过清除使用中标志取消400号MFT项的分配，访问$Bitmap文件的$DATA属性，将该项的相应位置0
7. 访问400号MFT项的非常驻属性，从$DATA属性中得到数据内容所在簇号，将$Bitmap文件中的相应簇的bit置0，取消722和723号簇的分配。
8. 在前面的每一步中，在文件日志中建立项并将改变记入$Extend$UsrJrnl。如果设置了配额管理，将在($Extend$Quota)中，把回收的容量从用户已使用的磁盘空间量中减去
